# Happy New Years!

Heres a quick-ish progress report on the goals I have set over a week ago:
- I have installed and configured fail2ban for both ssh and web servers on each node.
- I have (hopefully) solved my network issues with a new approach (see below).
- I have replaced `cloudflared` with `tailscale` ! 

## Network Changes

I have also made a few changes to my network structure. I have implemented VXLAN to connect my VMs and Containers via a new 10.0.100.0/24 network. However for ease of use, I wanted to also use DHCP for less critical applications, and I also wanted to be able to route out to the internet over that same network. 

Currently, Proxmox 9 does not support this for VXLAN as it does for the Simple zone, and Simple zones themselves do not provide layer-2 benefits either, so a custom solution must be created.

I got this to work by creating another simple zone with automatic DHCP to act as a host-facing interface that each vm will interact with, effectively wrapping over the VXLAN zone in a (hopefully) clean way. I also made sure to adjust the MTU value down to 1450 in the simple zone to match what VXLAN needs for overhead. Credits to [Mhdo](https://forum.proxmox.com/threads/a-way-to-get-dhcp-and-ipam-working-with-a-vxlan-zone-with-minimal-extra-configuration.169054/)!

Below is a custom SDN config (named "sdn-custom" to load after the Proxmox managed one) file that helps accomplish this, where `vnet1` is the Simple zone VNet and `vxnet1` is for the VXLAN network:
```
auto head
iface head inet manual
        link-type veth
        veth-peer-name tail

auto tail
iface tail inet manual
        link-type veth
        veth-peer-name head

iface vnet1 inet manual
        bridge_ports head

iface vxnet1 inet manual
        bridge_ports tail
```

This configuration successfully assigns IPs to each VM and container I spin up across each node in my cluster, however I still need to get internet connectivity. I initially was looking into bonding each wireless interface across each node, but I still cant find any information online that emulates this, let alone if it is even possible.

To keep things (more or less) simple, I have overwritten the SDN interface for `vnet1` at the top of my "sdn-custom" config file. each node creates a network bridge `vnet1` with MASQUERADE pointed towards the wireless interface with default gateway of `10.0.100.254/24`:

```
auto vnet1
iface vnet1
        address 10.0.100.254/24
        bridge_ports none
        bridge_stp off
        bridge_fd 0

        post-up   echo 1 > /proc/sys/net/ipv4/ip_forward
        post-up   iptables -t nat -A POSTROUTING -s '10.0.100.0/24' -o wlp2s0 -j MASQUERADE
        post-down iptables -t nat -D POSTROUTING -s '10.0.100.0/24' -o wlp2s0 -j MASQUERADE
        post-up   iptables -t raw -I PREROUTING -i fwbr+ -j CT --zone 1
        post-down iptables -t raw -D PREROUTING -i fwbr+ -j CT --zone 1

        mtu 1450
        ip-forward on
...
```

This *should* overwrite any changes made to vnet1, but I have yet to fully test this. If my connectivity persists across a node's IP getting renewed by the router, then I managed to fix this lol. 

Through this headache I discovered a weird limitation with Proxmox's UI while getting this all to work. Enabling `SNAT` in my Simple Zone's subnet will correctly use my `wlp2s0` interface but unfortunately sets a static IP (I am relying on a dynamic IP from my router). Ideally, I would like to manually set the interface at the very least, along with the ability to enable MASQUERADE instead. [Better DNAT/SNAT settings](https://bugzilla.proxmox.com/show_bug.cgi?id=5239) seem to be planned for a future release, which will be good to keep note of for updating later.

I still feel like this is messy. Maybe I should be using EVPN instead for this? I really should invest in a dedicated OPNsense router so I can ditch the on-board wireless for 2.5 Gigabit NICs!
